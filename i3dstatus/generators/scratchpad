#!/usr/bin/env python3

import i3ipc
import dbus
import json
import cgi

i3dstatus = dbus.Interface(dbus.SessionBus().get_object(
                           'com.dubstepdish.i3dstatus',
                           '/com/dubstepdish/i3dstatus'),
                           'com.dubstepdish.i3dstatus')

i3 = i3ipc.Connection()

scratchpad_format = 'scratchpad: <b>%classes</b>'

config = json.loads(i3dstatus.get_config('scratchpad'))

if 'format' in config:
    scratchpad_format = config['format']


def get_block():
    block = {"name": "scratchpad", "markup": "pango"}

    scratchpad = i3.get_tree().scratchpad().leaves()

    if not scratchpad:
        return block

    classes = ', '.join([l.window_class for l in scratchpad])
    full_text = scratchpad_format.replace('%classes', cgi.escape(classes))
    full_text = full_text.replace('%count', str(len(scratchpad)))

    block['full_text'] = full_text

    return block


def on_move(i3, e):
    i3dstatus.show_block(get_block())

i3dstatus.show_block(get_block())

i3.on('window::move', on_move)

i3.main()
