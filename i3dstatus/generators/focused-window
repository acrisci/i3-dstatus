#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import cgi
import os

from i3dstatus.block import Block

block = Block(os.path.basename(__file__))

try:
    import i3ipc
except ImportError as e:
    block.error('could not import python3 module i3ipc')
    raise e

truncate_length = 100

if 'truncate-length' in block.config:
    truncate_length = block.config['truncate-length']


def process_title(name):
    if not name:
        return ""

    if len(name) > truncate_length:
        name = name[0:truncate_length].rstrip() + 'â€¦'

    return cgi.escape(name)


def on_focus_title_change(_i3, e):
    if e.container.focused:
        block.show(process_title(e.container.name), markup='pango')

i3 = i3ipc.Connection()
i3.on('window::focus', on_focus_title_change)
i3.on('window::title', on_focus_title_change)

block.show(process_title(i3.get_tree().find_focused().name), markup='pango')

i3.main()
