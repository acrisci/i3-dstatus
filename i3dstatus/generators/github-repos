#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import time
import requests
import atexit
from requests.exceptions import ConnectionError
import os

from i3dstatus.block import Block

block = Block(os.path.basename(__file__))

# display aggregate info on your users github repos

block_name = 'github-repos'
format_str = '<span color="yellow">â˜…</span>%stars <small>?</small>%issues'
users = [ 'acrisci' ]
interval = 600

if 'users' in block.config:
    users = block.config['users']

if 'format' in block.config:
    format_str = block.config['format']

if 'interval' in block.config:
    interval = block.config['interval']

def show_block(stars, issues, watchers):
    context = {
        'users': ', '.join(users),
        'stars': str(stars),
        'issues': str(issues),
        'watchers': str(watchers),
    }

    block.show(format_str, context=context, markup='pango')

atexit.register(block.clear)

def main():
    while True:
        stars = 0
        issues = 0
        watchers = 0

        try:
            for user in users:
                url = 'https://api.github.com/users/%s/repos' % user
                repos = requests.get(url).json()
                for r in repos:
                    stars += r['stargazers_count']
                    issues += r['open_issues_count']
                    watchers += r['watchers_count']

            show_block(stars, issues, watchers)
        except ConnectionError:
            # oops couldn't connect
            pass

        time.sleep(interval)

if __name__ == '__main__':
    main()
